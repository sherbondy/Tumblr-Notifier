<!DOCTYPE html>
<html>
<head>

<script src="jquery-1.4.2.min.js" type="text/javascript"></script>
<script type="text/javascript">

// RATE: how frequently the dashboard API is polled (in seconds)
const RATE = 60*5;

// These are a huge pain to type repeatedly.
const app = safari.application;
const sec = safari.extension.secureSettings; // email and password
const set = safari.extension.settings; // everything else

//	every second, find out the last time you checked the dashboard
var interval = setInterval(findLastChecked, 1000);

sec.addEventListener("change", validateAccount, false);

app.addEventListener("message", handleMessage, false);
app.addEventListener("command", handleCommand, false);
app.addEventListener("validate", updateBadges, false);

function validateAccount(e) {
	var email = sec.email;
	var pass = sec.password;
	if (email && pass) {
		email = encodeURI(email.trim());
		pass = encodeURI(pass.trim());
		$.ajax({
			url: 'http://www.tumblr.com/api/authenticate', 
			data: {email: email, password: pass},
			type: 'POST',
			dataType: 'xml',
			success: function(data) {
				console.log("Account Valid.")
				set.account_valid = true;
			},
			error: function(e, r, s) {
				if (e.status == 403) {
					set.account_valid = false;
					invalidAlert();
				} else {
					console.log("Unexpected error: "+e.status);
				}
			}
		});
	}
}

// Sets the latest_post setting to the new value from the tumblr site.
function handleMessage(e) {
	if (e.name === "setLatest") {
		set.latest_post = parseInt(e.message);
		console.log("Latest post set to: "+set.latest_post);
		updateUnreadCount(0);
	}
}

function invalidAlert() {
	alert("Hey, bub. Looks like your account credentials are invalid. "
	+"Try retyping them, but carefully this time."
	+"\n(Safari->Preferences->Extensions->Tumblr Notifier)");
}

function handleCommand(e) {
	if (e.command === "loadDashboard") {
		/* 	Open Tumblr's dashboard in a new tab
			when a user clicks the Toolbar Item. */
		var new_tab = e.target.browserWindow.openTab();
		new_tab.url = "http://www.tumblr.com/dashboard";
	}
}

function updateBadges(e)
{
    if (e.command === "loadDashboard") {
		if ("badge" in e.target) {
        	e.target.badge = set.unread_posts;
		}
    }
}

function validateToolbarItems() {
	/* 	have to do this to insure that all open windows have their 
		toolbars updated with the latest unread post count. */
    var toolbarItems = safari.extension.toolbarItems;
    for (var i = 0; i < toolbarItems.length; ++i) {
        if (toolbarItems[i].identifier !== "tumblr_posts")
            continue;

        toolbarItems[i].validate();
    }
}

function updateUnreadCount(count) {
    set.unread_posts = count;
    validateToolbarItems();
}

function checkForPosts() {
	// maximum for num is 50
	if (set.account_valid && set.unread_posts <= 250) {
		interval = clearInterval(interval);
		
		$.ajax({
			url: 'http://www.tumblr.com/api/dashboard', 
			data: {email: sec.email, password: sec.password, 
				   start:set.unread_posts, num: 50},
			type: 'POST',
			dataType: 'xml',
			
			success: function(data) {
				// If the user hasn't visited tumblr, set the latest post
				if (set.latest_post == 0) {
					set.latest_post = parseInt($(data).find("post:first").attr("id"));
					console.log("Latest post set to: "+set.latest_post);
				}
				
				count = $(data).find("post[id='"+set.latest_post+"']").index();
				
				if (count >= 0) {
					total = count + set.unread_posts;
					console.log("Unread count: "+total);
					updateUnreadCount(total);
				}
				
				set.last_checked = new Date().getTime();
				interval = setInterval(findLastChecked, 1000);
			},
			error: function(e, r, s) {
				if (e.status == 403) {
					set.account_valid = false;
					invalidAlert();
					interval = setInterval(findLastChecked, 1000);
				} else {
					console.log("Unexpected error: "+e.status);
					interval = setInterval(findLastChecked, 30000);
				}
			}
		});
	} else {
		if(!set.account_valid) {
			console.log("Invalid Account.");
		}
		if(set.unread_posts > 250) {
			console.log("Too many posts to keep track of.");
		}
	}
}

function findLastChecked() {
	if (set.last_checked == "never") {
		checkForPosts();
	} else {
		// Determine the difference in seconds since last checked
		var now = new Date().getTime();
		var diff_secs = parseInt((now - set.last_checked)/1000);
		
		if (diff_secs > RATE) {
			checkForPosts();
		}
	}
}

</script>
</head>
<body>
</body>
</html>