<!DOCTYPE html>
<html>
<head>

<script src="jquery-1.4.2.min.js" type="text/javascript"></script>
<script type="text/javascript">

const app = safari.application;
const sec = safari.extension.secureSettings; // email and password
const set = safari.extension.settings; // everything else

// checking every 20 seconds
setInterval(checkForPosts, 20000);

sec.addEventListener("change", validateSettings, false);

app.addEventListener("message", handleMessage, false);
app.addEventListener("command", handleCommand, false);
app.addEventListener("validate", performValidate, false);

function validateSettings(e) {
	var email = sec.email;
	var pass = sec.password;
	if (email && pass) {
		email = encodeURI(email.trim());
		pass = encodeURI(pass.trim());
		$.ajax({
			url: 'http://www.tumblr.com/api/authenticate', 
			data: {email: email, password: pass},
			type: 'POST',
			dataType: 'xml',
			success: function(data) {
				console.log("Account Valid.")
				set.account_valid = true;
			},
			error: function(e, r, s) {
				console.log("Error: "+e.status);
				set.account_valid = false;
			}
		});
	}
}

// Sets the latest_post setting to the new value from the tumblr site.
function handleMessage(e) {
	if (e.name === "setLatest") {
		set.latest_post = parseInt(e.message);
		console.log("We have a real post! ID: "+set.latest_post);
		updateUnreadCount(0);
	}
}

function handleCommand(e) {
	if (e.command === "loadDashboard") {
		var new_tab = e.target.browserWindow.openTab();
		new_tab.url = "http://www.tumblr.com/dashboard";
	}
}

function performValidate(e)
{
    if (e.command === "loadDashboard") {
		if ("badge" in e.target) {
        	e.target.badge = set.unread_posts;
			console.log("Unread count updated to: "+set.unread_posts);
		}
    }
}

function validateToolbarItems() {
    var toolbarItems = safari.extension.toolbarItems;
    for (var i = 0; i < toolbarItems.length; ++i) {
        if (toolbarItems[i].identifier !== "tumblr_posts")
            continue;

        toolbarItems[i].validate();
    }
}

function updateUnreadCount(count) {
    set.unread_posts = count;
    validateToolbarItems();
}

function checkForPosts() {
	// maximum for num is 50. 20 seems adequate for now
	if (set.account_valid && set.latest_post != 0) {
		$.ajax({
			url: 'http://www.tumblr.com/api/dashboard', 
			data: {email: sec.email, password: sec.password, num: 20},
			type: 'POST',
			dataType: 'xml',
			success: function(data) {
				count = $(data).find("post[id='"+set.latest_post+"']").index();
				if (count) {
					console.log("Index of last seen post is "+count);
					updateUnreadCount(count);
				}
			},
			error: function(e, r, s) {
				console.log("Tumblr server error: "+e.status);
			}
		});
	} else {
		if(!set.account_valid) {
			console.log("Can't check for posts yet. Invalid Account.");
		}
		if(set.latest_post == 0) {
			console.log("Can't check for posts yet. Haven't visited Tumblr.");
		}
	}
}

</script>
</head>
<body>
</body>
</html>